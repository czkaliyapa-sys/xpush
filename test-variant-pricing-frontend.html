<!DOCTYPE html>
<html>
<head>
    <title>Variant Pricing Synchronization Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Variant Pricing Synchronization Test</h1>
    <div id="results"></div>

    <script type="module">
        // Import the variant pricing system
        import { variantPricingUtils, adminDashboardHelpers, cartIntegrationHelpers } from './variant-pricing-sync-system.js';

        const resultsDiv = document.getElementById('results');
        
        // Sample test data
        const sampleGadget = {
            id: 1,
            name: 'iPhone 15 Pro',
            price: 2500000, // MWK
            price_gbp: 3200, // GBP
            stock_quantity: 5,
            is_active: 1,
            category: 'smartphones',
            brand: 'Apple',
            model: 'iPhone 15 Pro'
        };

        const sampleVariants = [
            {
                id: 101,
                gadgetId: 1,
                color: 'Black',
                storage: '128GB',
                condition_status: 'Excellent',
                price: 2400000, // MWK
                price_gbp: 3100, // GBP
                stock_quantity: 2,
                is_active: 1
            },
            {
                id: 102,
                gadgetId: 1,
                color: 'White',
                storage: '256GB',
                condition_status: 'Good',
                price: 2300000, // MWK
                price_gbp: 2950, // GBP
                stock_quantity: 3,
                is_active: 1
            },
            {
                id: 103,
                gadgetId: 1,
                color: 'Blue',
                storage: '128GB',
                condition_status: 'Fair',
                price: 2100000, // MWK
                price_gbp: 2700, // GBP
                stock_quantity: 1,
                is_active: 1
            },
            {
                id: 104,
                gadgetId: 1,
                color: 'Black',
                storage: '512GB',
                condition_status: 'Excellent',
                price: 2600000, // MWK
                price_gbp: 3350, // GBP
                stock_quantity: 0, // Out of stock
                is_active: 1
            }
        ];

        // Test functions
        function addTestResult(title, result, details = '') {
            const div = document.createElement('div');
            div.className = 'test-section';
            div.innerHTML = `
                <h3>${title}</h3>
                <div class="test-result ${result}">
                    ${result.toUpperCase()}: ${details}
                </div>
            `;
            resultsDiv.appendChild(div);
        }

        function runTests() {
            // Test 1: Basic variant processing
            try {
                const processed = variantPricingUtils.processGadgetWithVariants(sampleGadget, sampleVariants);
                
                console.log('Processed gadget:', processed);
                
                // Verify lowest price is correct (should be 2100000 MWK from Fair condition)
                const expectedLowestPrice = 2100000;
                const priceCorrect = processed.price === expectedLowestPrice;
                
                // Verify stock calculation (2 + 3 + 1 = 6, ignoring out-of-stock)
                const expectedStock = 6;
                const stockCorrect = processed.stock_quantity === expectedStock;
                
                // Verify variant metadata
                const metadataCorrect = processed.has_variants && 
                                     processed.has_active_variants && 
                                     processed.variant_count === 4 &&
                                     processed.active_variant_count === 3;
                
                if (priceCorrect && stockCorrect && metadataCorrect) {
                    addTestResult(
                        'Test 1: Basic Variant Processing',
                        'pass',
                        `‚úì Lowest price: MK ${processed.price.toLocaleString()} ‚úì Stock: ${processed.stock_quantity} ‚úì Variants: ${processed.variant_count}`
                    );
                } else {
                    addTestResult(
                        'Test 1: Basic Variant Processing',
                        'fail',
                        `Expected price: ${expectedLowestPrice}, Got: ${processed.price}. Expected stock: ${expectedStock}, Got: ${processed.stock_quantity}`
                    );
                }
            } catch (error) {
                addTestResult('Test 1: Basic Variant Processing', 'fail', error.message);
            }

            // Test 2: Admin dashboard helpers
            try {
                const formData = adminDashboardHelpers.prepareGadgetFormData(sampleGadget, sampleVariants);
                const validation = adminDashboardHelpers.validateVariants(sampleVariants);
                
                console.log('Admin form data:', formData);
                console.log('Validation result:', validation);
                
                const formValid = formData.inStock === true && formData.stockQuantity === 6;
                const validationPassed = validation.valid === true;
                
                if (formValid && validationPassed) {
                    addTestResult(
                        'Test 2: Admin Dashboard Integration',
                        'pass',
                        '‚úì Form data prepared correctly ‚úì Validation passed'
                    );
                } else {
                    addTestResult(
                        'Test 2: Admin Dashboard Integration',
                        'fail',
                        `Form validation: ${formValid}, Variant validation: ${validationPassed}`
                    );
                }
            } catch (error) {
                addTestResult('Test 2: Admin Dashboard Integration', 'fail', error.message);
            }

            // Test 3: Cart integration
            try {
                const cartItem = cartIntegrationHelpers.prepareCartItem(
                    { id: 1, quantity: 1 },
                    variantPricingUtils.processGadgetWithVariants(sampleGadget, sampleVariants),
                    102 // White 256GB variant
                );
                
                console.log('Cart item:', cartItem);
                
                const priceCorrect = cartItem.price === 2300000; // Should use variant price
                const hasVariantData = cartItem.has_variant_pricing === true;
                const variantMetadata = cartItem.variant_data?.storage === '256GB';
                
                if (priceCorrect && hasVariantData && variantMetadata) {
                    addTestResult(
                        'Test 3: Cart Integration',
                        'pass',
                        `‚úì Variant price applied: MK ${cartItem.price.toLocaleString()} ‚úì Variant data included`
                    );
                } else {
                    addTestResult(
                        'Test 3: Cart Integration',
                        'fail',
                        `Price correct: ${priceCorrect}, Has variant data: ${hasVariantData}`
                    );
                }
            } catch (error) {
                addTestResult('Test 3: Cart Integration', 'fail', error.message);
            }

            // Test 4: Stock information
            try {
                const processed = variantPricingUtils.processGadgetWithVariants(sampleGadget, sampleVariants);
                const stockInfo = variantPricingUtils.getStockInfo(processed);
                
                console.log('Stock info:', stockInfo);
                
                const correctQuantity = stockInfo.quantity === 6;
                const correctStatus = stockInfo.inStock === true;
                const correctAvailability = stockInfo.availability === 'available';
                
                if (correctQuantity && correctStatus && correctAvailability) {
                    addTestResult(
                        'Test 4: Stock Information',
                        'pass',
                        `‚úì Quantity: ${stockInfo.quantity} ‚úì Status: ${stockInfo.status} ‚úì Availability: ${stockInfo.availability}`
                    );
                } else {
                    addTestResult(
                        'Test 4: Stock Information',
                        'fail',
                        `Quantity: ${correctQuantity}, Status: ${correctStatus}, Availability: ${correctAvailability}`
                    );
                }
            } catch (error) {
                addTestResult('Test 4: Stock Information', 'fail', error.message);
            }

            // Test 5: Variant matching
            try {
                const match = variantPricingUtils.findMatchingVariant(
                    sampleVariants,
                    'White',
                    '256GB',
                    'Good'
                );
                
                console.log('Variant match:', match);
                
                const foundCorrect = match !== null;
                const correctVariant = match?.id === 102;
                
                if (foundCorrect && correctVariant) {
                    addTestResult(
                        'Test 5: Variant Matching',
                        'pass',
                        `‚úì Found variant ${match.id} with correct attributes`
                    );
                } else {
                    addTestResult(
                        'Test 5: Variant Matching',
                        'fail',
                        `Found: ${foundCorrect}, Correct ID: ${correctVariant ? match?.id : 'N/A'}`
                    );
                }
            } catch (error) {
                addTestResult('Test 5: Variant Matching', 'fail', error.message);
            }

            // Summary
            const allResults = document.querySelectorAll('.test-result');
            const passed = document.querySelectorAll('.pass').length;
            const total = allResults.length;
            const percentage = Math.round((passed / total) * 100);
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-section';
            summaryDiv.style.marginTop = '30px';
            summaryDiv.style.padding = '20px';
            summaryDiv.style.backgroundColor = '#f8f9fa';
            summaryDiv.style.border = '2px solid #007bff';
            summaryDiv.innerHTML = `
                <h2>üìä Test Summary</h2>
                <div style="font-size: 18px; font-weight: bold;">
                    Tests Passed: ${passed}/${total} (${percentage}%)
                </div>
                <div style="margin-top: 10px;">
                    ${passed === total 
                        ? 'üéâ All tests passed! Variant pricing synchronization is working correctly.'
                        : passed > total * 0.7 
                            ? '‚ö†Ô∏è Most tests passed. Some minor issues detected.'
                            : '‚ùå Significant issues detected. Review failed tests above.'
                    }
                </div>
            `;
            resultsDiv.appendChild(summaryDiv);
        }

        // Run tests when page loads
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>