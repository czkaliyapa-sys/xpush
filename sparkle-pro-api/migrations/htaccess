RewriteEngine On

# Route CORS preflight (OPTIONS) requests to index.php so PHP can set
# specific Access-Control-Allow-Origin and Allow-Credentials correctly
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ index.php [QSA,L]

# Bypass rewrites for static model assets under /models
# Ensures requests like /api/models/... are served directly by Apache
RewriteRule ^models/ - [L]

# Route all API requests to index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# CORS headers for static model assets only (scoped to /api/models)
<IfModule mod_headers.c>
  # Work for both /api/models/... and /models/... depending on docroot
  SetEnvIf Request_URI "^/api/models/" MODELS_PATH=1
  SetEnvIf Request_URI "^/models/" MODELS_PATH=1

  Header always set Access-Control-Allow-Origin "*" env=MODELS_PATH
  Header always set Access-Control-Allow-Methods "GET, HEAD, OPTIONS" env=MODELS_PATH
  Header always set Access-Control-Allow-Headers "Origin, Accept, Content-Type" env=MODELS_PATH
  Header always set Access-Control-Expose-Headers "Content-Length, Content-Type, Accept-Ranges, Content-Range" env=MODELS_PATH
  Header always set Timing-Allow-Origin "*" env=MODELS_PATH
  
  # Content Security Policy: Allow location detection services and other required domains
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.pmndrs.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com https://m.stripe.network https://accounts.google.com https://securetoken.googleapis.com https://www.googleapis.com https://firebase.googleapis.com https://firestore.googleapis.com https://sparkle-pro.co.uk https://*.sparkle-pro.co.uk https://www.sparkle-pro.co.uk https://itsxtrapush.com https://www.googletagmanager.com https://cdn.pmndrs.com https://cdn.jsdelivr.net https://market-assets.fra1.digitaloceanspaces.com https://raw.githubusercontent.com https://get.geojs.io https://www.cloudflare.com blob:; frame-src 'self' https://accounts.google.com https://securetoken.firebase.com; object-src 'none'; base-uri 'self'; form-action 'self';"
</IfModule>

# MIME types for GLTF/GLB and related assets
AddType model/gltf+json .gltf
AddType model/gltf-binary .glb
AddType application/octet-stream .bin
AddType application/json .json
AddType text/plain .obj .mtl
AddType image/png .png
AddType image/jpeg .jpg .jpeg
AddType image/webp .webp

# IMPORTANT: Do not set general static CORS headers here.
# index.php manages CORS per-origin and includes Allow-Credentials.
# The headers above are scoped only to /api/models/ static files.