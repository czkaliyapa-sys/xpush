RewriteEngine On

# Bypass rewrites for static model assets under /models
RewriteRule ^models/ - [L]

# Route CORS preflight (OPTIONS) requests to index.php so PHP can set
# specific Access-Control-Allow-Origin and Allow-Credentials correctly
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ index.php [QSA,L]

# Route all API requests to index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# CORS headers for static model assets only (scoped to /api/models)
<IfModule mod_headers.c>
    # Work for both /api/models/... and /models/... depending on docroot
    SetEnvIf Request_URI "^/api/models/" MODELS_PATH=1
    SetEnvIf Request_URI "^/models/" MODELS_PATH=1
    # General CORS headers for all other API endpoints (temporary: allow all origins)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # General CORS headers for OPTIONS responses (handled by PHP)
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control  "true"
    
    # Don't set Access-Control-Allow-Origin here for non-static files
    # Let PHP handle it dynamically based on the request origin
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.pmndrs.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com https://m.stripe.network https://accounts.google.com https://securetoken.googleapis.com https://www.googleapis.com https://firebase.googleapis.com https://firestore.googleapis.com https://sparkle-pro.co.uk https://*.sparkle-pro.co.uk https://www.sparkle-pro.co.uk https://itsxtrapush.com https://www.googletagmanager.com https://cdn.pmndrs.com https://cdn.jsdelivr.net https://market-assets.fra1.digitaloceanspaces.com https://raw.githubusercontent.com https://get.geojs.io https://www.cloudflare.com blob:; frame-src 'self' https://accounts.google.com https://securetoken.firebase.com; object-src 'none'; base-uri 'self'; form-action 'self';"
</IfModule>

# MIME types
AddType model/gltf+json .gltf
AddType model/gltf-binary .glb
AddType application/octet-stream .bin
AddType application/json .json
AddType text/plain .obj .mtl
AddType image/png .png
AddType image/jpeg .jpg .jpeg
AddType image/webp .webp